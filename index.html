<!--    
* SysExplorer - A System Explorer for the blockchain of Minima
        
* @eliasnem
   
* Created on 27/08/2020. 
-->

<!DOCTYPE html>
    
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>SysExplorer</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" 
              integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" 
              crossorigin="anonymous">              
        <link rel="stylesheet" href="css/styles.css">


    </head>
    <body>
        <div class="m-2 text-center">
            
            <!-- TITLE -->
            

            <img src="assets/icon.png" alt="Minima Icon" class="rounded-0 img-fluid" style="width: 45px;">
            <h5 class="title ml2"> Minima's System Explorer. </h5>
    
            <hr class="mb-light-mb-5" style="background-color:#616274;">

            <!-- welcoming ALERT -->
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong>Welcome to Minima's System Explorer.</strong> If you haven't joined our telegram, join <a href="https://t.me/Minima_Global" class="alert-link" target="_blank">here</a>.
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>



            <div class="container text-center">
                <div class="row">
                    <div class="col-sm align-middle">
                        <div class="card" style="width: 18rem;">
                            <div class="card-body">
                            <h5 id="blocks-mined" class="card-title"></h5>
                            <p class="card-text">Blocks Mined</p>
                            <h6 class="card-subtitle mb-2 text-muted">Total blocks currently mined in the chain.</h6>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm ml-5 align-middle">
                        <div class="card" style="width: 18rem;">
                            <div class="card-body">
                            <h5 id="chain-speed" class="card-title" style="font-size: 12px;"></h5>
                            <p class="card-text">Chainspeed</p>
                            <h6 class="card-subtitle mb-2 text-muted">Speed of the chain aggregating blocks.</h6>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm ml-5 align-middle">
                        <div class="card" style="width: 18rem;">
                            <div class="card-body">
                            <h5 id="uptime" class="card-title" style="font-size: 12px;"></h5>
                            <p class="card-text">Uptime</p>
                            <h6 class="card-subtitle mb-2 text-muted">Uptime of your node synced to the network.</h6>
                            </div>
                        </div>
                    </div>

                </div>   
            </div>

            <div class="m-5">
                <div class="card col-md-6 offset-md-3">
                    <canvas id="blocks-canvas"></canvas>
                </div>
            </div>




            <!-- Use this for loading -->
            <!-- <div class="spinner">
                <div class="cube1"></div>
                <div class="cube2"></div>
            </div> -->
                
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js" integrity="sha512-rmZcZsyhe0/MAjquhTgiUcb4d9knaFc7b5xAfju483gbEXTkeJRUMIPk6s3ySZMYUHEcjKbjLjyddGWMrNEvZg==" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" integrity="sha512-s+xg36jbIujB2S2VKfpGmlC3T5V2TF3lY48DX7u2r9XzGzgPsa6wTpOQA7J9iffvdeBN0q9tKzRxVxw1JviZPg==" crossorigin="anonymous"></script>
        <script>
            var ctx = document.getElementById('blocks-canvas').getContext('2d');
            var blocks = [];
            var timestamp = [];

            function addData(tstamp, blknum) {
                
                tstamp = moment(tstamp*1000); // convert tstamp to ms, then convert to date
                
                chart.data.labels.push(tstamp); // add new block timestamp to array
                chart.data.datasets[0].data.push(blknum); // add new block to array
                chart.update(); // re-render chart

                // Check if too much data, then concatenate
                if(chart.data.datasets[0].data.length > 15) {
                    chart.data.datasets[0].data.shift();
                    chart.data.labels.shift();
                }

            }
            
            var chart = new Chart(ctx, {

                type: 'line',
                data: {
                    labels: [], // xAxes labels; use this for block's timestamp
                    datasets:[{
                        label:'Block Number',
                        data: [], // yAxes data, this is the block number
                        backgroundColor: 'rgb(70,72,97, 0.9)',
                        borderColor: 'rgb(246,102,29, 0.9)',
                        borderWidth: 1,
                        pointStyle: 'rectRounded',
                    }]                     
                },
                options: {
                    title: {
                        display: true,
                        text: 'Block/Time Chart',
                        fontColor: 'rgb(70, 72, 97, 0.9)',
                        fontSize: 12
                    },
                    scales: {
                        xAxes: [{
                            type: 'time',
                            time: {
                                unit: 'seconds',
                                stepSize: 15,
                                displayFormats: {
                                    seconds: 'h:mm:ss a'
                                }
                            }
                        }],
                        yAxes: [{
                            type: 'linear',
                            ticks: {
                                stepSize: 5
                            }
                        }]
                    },
                    legend: {
                        display: true,
                        position: 'bottom',
                        reverse: true,
                        labels: {
                            boxWidth: 25,
                            fontSize: 10,
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }

            });
        </script>
        <!-- Minima Script -->
        <script type="text/javascript">

            

            // Minima Event Manager
            window.addEventListener("load", function(){
                window.addEventListener("MinimaEvent", function(evt){
                    // Deal with each message type. 
                    if(evt.detail.event === "connected"){
                        console.log("@M: Connection Successful.");
                    } else if(evt.detail.event === "newblock"){
                        console.log("@Minima: New block.");
                        // Add blocks to block/time chart

                        $(document).ready(function(){

                            document.getElementById('blocks-mined').innerText = Minima.block;
                            document.getElementById('chain-speed').innerText = Minima.status.chainspeed;
                            document.getElementById('uptime').innerText = Minima.status.uptime;

            
                        });

                        var timestamp = "";
                        Minima.cmd("txpowinfo "+Minima.status.tip, function(res){
                            if(res.status){
                                timestamp = res.response.txpow.header.timesecs;
                                
                                addData(timestamp, Minima.block);

                            }
                        });

                    } else if(evt.detail.event === "newbalance"){
                        console.log("@M: Balance update.")
                    }
                });
                Minima.init();
            });

            // Create a SQL Table. 
            function initSQL(){
                Minima.sql("CREATE TABLE IF NOT EXISTS blockvstime (height VARCHAR(160) NOT NULL, timestamp VARCHAR(160); SELECT DISTINCT height, timestamp FROM blockvstime", function(resp){
                    if(!resp.status){
                        console.log("@M: SQL ERROR!");
                    }
                });
            }
            // Populate blocks and timestamps arrays
            function populateArr(){

            }
            
    
        </script>

        <script src="" async defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
        <script>
            /*
                Tobias Sahlin Sick Animations
                https://tobiasahlin.com/moving-letters/#1/
            */
            // Wrap every letter in a span
            var textWrapper = document.querySelector('.ml2');
            textWrapper.innerHTML = textWrapper.textContent.replace(/\S/g, "<span class='letter'>$&</span>");
    
            anime.timeline({loop: true})
            .add({
                targets: '.ml2 .letter',
                scale: [4,1],
                opacity: [0,1],
                translateZ: 0,
                easing: "easeOutExpo",
                duration: 950,
                delay: (el, i) => 70*i
            }).add({
                targets: '.ml2',
                opacity: 0,
                duration: 1000,
                easing: "easeOutExpo",
                delay: 10000
            });
            </script>
        <script src="js/minima.js" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    </body>
</html>
